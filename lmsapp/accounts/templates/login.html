{% extends "base.html" %}
{% block content %}
<div class="w-1/2">

        <form class="bg-white shadow-md rounded px-8 p-5" id="user_form" method="post" action="/api/login/"
                enctype="multipart/form-data">
            <h1 class="text-3xl font-bold text-gray-800 pb-6">Login</h1>
            {% csrf_token %}

            <div class="mb-4">
                <label class="block text-gray-800 text-sm font-bold mb-3" for="username">Username:</label>
                <input class="shadow appearence-none border rounded w-full py-2 px-4 focus:shadow-outline" type="text" id="username" name="username" placeholder="Username" required>
                </div>

                <div class="mb-4">
                <label class="block text-gray-800 text-sm font-bold mb-3" for="password">Password:</label>
                <input class="shadow appearence-none border rounded w-full py-2 px-4 focus:shadow-outline" type="password" id="password" name="password" placeholder="********" required>
                </div>

                    {% if error_message %}
                    <div class="error pb-5">
                        <p class="text-red-700">{{error_message}}</p>
                    </div>
                    {% endif %}

                <div class="flex items-center justify-between">
                    <button class="bg-blue-600 hover:bg-blue-800 text-white font-bold py-4 px-6 rounded focus:shadow-outline" type="submit">Login</button>
                </div>


        </form>

    </div>

    <script>
        document.getElementById('user_form').addEventListener('submit', function(event) {
            event.preventDefault();
    
            var formData = new FormData(this);
    
            fetch('/api/login/', {
                method: 'POST',
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                if (data.token && data.profile_url) {
                    // Store token in local storage
                    localStorage.setItem('token', data.token);
                    
                    // Add token to Authorization header
                    var headers = new Headers();
                    headers.append('Authorization', 'Token ' + data.token);
    
                    // Fetch profile_url with authorization header
                    fetch(data.profile_url, {
                        method: 'GET',
                        headers: headers,
                    })
                    .then(profileResponse => {
                        if (profileResponse.ok) {
                            window.location.href = data.profile_url;
                        } else {
                            throw new Error('Failed to fetch profile data');
                        }
                    })
                    .catch(profileError => {
                        console.error('Profile request failed:', profileError);
                    });
                } else {
                    var errorMessageElement = document.getElementById('error_message');
                    if (errorMessageElement) {
                        errorMessageElement.style.display = 'block';
                        errorMessageElement.innerHTML = '<p class="text-red-700">' + (data.error || 'An error occurred.') + '</p>';
                    }
                }
            })
            .catch(error => {
                console.error('Login request failed:', error);
                var errorMessageElement = document.getElementById('error_message');
                if (errorMessageElement) {
                    errorMessageElement.style.display = 'block';
                    errorMessageElement.innerHTML = '<p class="text-red-700">An error occurred. Please try again.</p>';
                }
            });
        });
    </script>
{% endblock %}

 
